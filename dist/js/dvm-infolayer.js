function getURLGetFeatureInfo4WMTSLayer(urlQueryGFI,layerQueryGFI,evt,viewResolution,useProxy){var GFI_lyr=new ol.layer.Tile({source:new ol.source.TileWMS({url:urlQueryGFI,params:{LAYERS:layerQueryGFI}})});1==useProxy?getURLGetFeatureInfoLayerWithProxy(GFI_lyr,evt,viewResolution):getURLGetFeatureInfoLayer(GFI_lyr,evt,viewResolution)}function getURLGetFeatureInfoLayerWithProxy(ol3_lyr,evt,viewResolution){var urlGetFeatureInfo=ol3_lyr.getSource().getGetFeatureInfoUrl(evt.coordinate,viewResolution,"EPSG:3857",{INFO_FORMAT:"text/html"});cadHTML="<div class='alert alert-warning alert-dismissible infoWMS' role='alert' ><button type='button' class='close' data-dismiss='alert' aria-label='Close' onclick=\"$('#listaSelMaps').trigger('heightChange');\"><span aria-hidden='true'>&times;</span></button><strong>"+ol3_lyr.getProperties().title+"</strong><br/><iframe class='iframeGetFeatureInfo' src='./proxyGFI.php?urlCapabilities="+urlGetFeatureInfo+"'></iframe></div>";var container=document.getElementById("listaSelMaps"),resultsPrevios=container.innerHTML;container.innerHTML=cadHTML+resultsPrevios,$(".listaSelMapsclass").show(500)}function getURLGetFeatureInfoLayer(ol3_lyr,evt,viewResolution){var urlGetFeatureInfo=ol3_lyr.getSource().getGetFeatureInfoUrl(evt.coordinate,viewResolution,"EPSG:3857",{INFO_FORMAT:"text/html"}),titleLyr="";void 0!==ol3_lyr.getProperties().title&&(titleLyr=ol3_lyr.getProperties().title),cadHTML="<div class='alert alert-warning alert-dismissible infoWMS' role='alert' ><button type='button' class='close' data-dismiss='alert' aria-label='Close' onclick=\"$('#listaSelMaps').trigger('heightChange');\"><span aria-hidden='true'>&times;</span></button><strong>"+titleLyr+"</strong><br/><iframe class='iframeGetFeatureInfo' src='"+urlGetFeatureInfo+"'></iframe></div>";var container=document.getElementById("listaSelMaps"),resultsPrevios=container.innerHTML;container.innerHTML=cadHTML+resultsPrevios,$(".listaSelMapsclass").show(500)}function getURLGetFeatureInfoAB(bbox,width,height,longitude,latitude){return"http://www.ign.es/wms-inspire/unidades-administrativas?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=AU.AdministrativeBoundary&QUERY_LAYERS=AU.AdministrativeBoundary&STYLES=&BBOX="+bbox+"&FEATURE_COUNT=5&HEIGHT="+height+"&WIDTH="+width+"&FORMAT=image/png&INFO_FORMAT=text/html&SRS=EPSG:4326&X="+longitude+"&Y="+latitude}function getURLGetFeatureInfoAU(bbox,width,height,longitude,latitude){return"http://www.ign.es/wms-inspire/unidades-administrativas?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=AU.AdministrativeUnit&QUERY_LAYERS=AU.AdministrativeUnit&STYLES=&BBOX="+bbox+"&FEATURE_COUNT=5&HEIGHT="+height+"&WIDTH="+width+"&FORMAT=image/png&INFO_FORMAT=text/html&SRS=EPSG:4326&X="+longitude+"&Y="+latitude}function getWMSAU(bbox,width,height,longitude,latitude){$.ajax({url:getURLGetFeatureInfoAU(bbox,width,height,longitude,latitude),dataType:"html",type:"GET",beforeSend:function(){$("#resultNoSpin").hide(),$("#resultSpin").show(),numLineas=0},success:function(data){$(data);var container=document.getElementById("listaSelMaps"),cadCodINSPIRE=$(data).find("#idinspire .text-info:first").map(function(){return $(this).text()}).get().join("|"),cadNombreUnidad=$(data).find("#nombre .text-info").map(function(){return $(this).text()}).get().join("|"),cadJerarqLevel=$(data).find("#nivel .text-info").map(function(){return $(this).text()}).get().join("|"),codigosINSPIRE=($(data).find("#nombre .text-info a").map(function(){return $(this).attr("href")}).get().join("|"),cadCodINSPIRE.split("|")),nombresUnidad=cadNombreUnidad.split("|"),jerarqLevel=cadJerarqLevel.split("|"),cadHTML="";if(""!=cadCodINSPIRE){numLineas=codigosINSPIRE.length;for(var nomMuni="",nomProvin="",nomAutonom="",codINE="",codINEprov="",codINEauto="",i=0;i<codigosINSPIRE.length;i++)"4thOrder"==jerarqLevel[i]&&(nomMuni=nombresUnidad[i],codINE=codigosINSPIRE[i]),"3rdOrder"==jerarqLevel[i]&&(nomProvin=nombresUnidad[i],codINEprov=codigosINSPIRE[i]),"2ndOrder"==jerarqLevel[i]&&(nomAutonom=nombresUnidad[i],codINEauto=codigosINSPIRE[i]);cadHTML=""!=nomMuni?cadHTML+"<div class='alert alert-warning alert-dismissible infoBDLJE' role='alert' ><button type='button' class='close' data-dismiss='alert' aria-label='Close' onclick=\"$('#listaSelMaps').trigger('heightChange');\"><span aria-hidden='true'>&times;</span></button><strong>"+nomMuni+"</strong><br/><em><small>"+codINE+"</small></em><br/><em>"+nomProvin+"("+nomAutonom+')</em><br/><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=ACLLI&filtro.codIne="+replaceAll(codINE,"ES.IGN.SIGLIM.",""))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-book" aria-hidden="true"></i> Documentación deslindes</a><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=MIPAC&filtro.codIne="+replaceAll(codINE,"ES.IGN.SIGLIM.",""))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-map" aria-hidden="true"></i> Planimetrías y altimetrías</a><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=PLPOB&filtro.codIne="+replaceAll(codINE,"ES.IGN.SIGLIM.",""))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-map" aria-hidden="true"></i> Planos de población</a></div>':""!=codINEprov?cadHTML+"<div class='alert alert-warning alert-dismissible infoBDLJE' role='alert' ><button type='button' class='close' data-dismiss='alert' aria-label='Close' onclick=\"$('#listaSelMaps').trigger('heightChange');\"><span aria-hidden='true'>&times;</span></button><strong>"+nomProvin+"("+nomAutonom+')</strong><br/><em><small>Haga más zoom para identificar municipios</small></em><br/><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=ACLLI&filtro.codProv="+parseInt(codINEprov.substring(18,20)))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-book" aria-hidden="true"></i> Documentación deslindes</a><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=MIPAC&filtro.codProv="+parseInt(codINEprov.substring(18,20)))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-map" aria-hidden="true"></i> Planimetrías y altimetrías</a><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=PLPOB&filtro.codProv="+parseInt(codINEprov.substring(18,20)))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-map" aria-hidden="true"></i> Planos de población</a></div>':cadHTML+"<div class='alert alert-warning alert-dismissible infoBDLJE' role='alert' ><button type='button' class='close' data-dismiss='alert' aria-label='Close' onclick=\"$('#listaSelMaps').trigger('heightChange');\"><span aria-hidden='true'>&times;</span></button><strong>"+nomAutonom+'</strong><br/><em><small>Haga más zoom para identificar municipios</small></em><br/><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=ACLLI&filtro.codCA="+parseInt(codINEauto.substring(16,18)))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-book" aria-hidden="true"></i> Documentación deslindes</a><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=MIPAC&filtro.codCA="+parseInt(codINEauto.substring(16,18)))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-map" aria-hidden="true"></i> Planimetrías y altimetrías</a><a href="'+("http://centrodedescargas.cnig.es/CentroDescargas/buscar.do?filtro.codFamilia=PLPOB&filtro.codCA="+parseInt(codINEauto.substring(16,18)))+'" class="btn btn-primary btn-block btn-xs" target="_blank"><i class="fa fa-map" aria-hidden="true"></i> Planos de población</a></div>';var resultsPrevios=container.innerHTML;container.innerHTML=cadHTML+resultsPrevios}},error:function(e){},complete:function(){$("#resultNoSpin").show(),$("#resultSpin").hide()}})}function getWMSAB(bbox,width,height,longitude,latitude){$.ajax({url:getURLGetFeatureInfoAB(bbox,width,height,longitude,latitude),dataType:"html",type:"GET",beforeSend:function(){$("#resultNoSpin").hide(),$("#resultSpin").show(),numLineas=0},success:function(data){$(data);var container=document.getElementById("listaSelMaps"),cadCodINSPIRE=$(data).find("#idinspire .text-info:first").map(function(){return $(this).text()}).get().join("|"),cadNombreLinea=$(data).find("#nombre .text-info").map(function(){return $(this).text()}).get().join("|"),cadJerarqLevel=$(data).find("#nivel .text-info").map(function(){return $(this).text()}).get().join("|"),cadhojaRegistral=$(data).find("#nombre .text-info a").map(function(){return $(this).attr("href")}).get().join("|"),codigosINSPIRE=cadCodINSPIRE.split("|"),nombresLinea=cadNombreLinea.split("|"),jerarqLevel=cadJerarqLevel.split("|"),hojasReg=cadhojaRegistral.split("|"),cadHTML="";if(""!=cadCodINSPIRE){numLineas=codigosINSPIRE.length;for(var i=0;i<codigosINSPIRE.length;i++)hojasReg[i].substr(hojasReg[i].length-18).substring(0,14),cadHTML=cadHTML+"<div class='alert alert-warning alert-dismissible infoBDLJE' role='alert' ><button type='button' class='close' data-dismiss='alert' aria-label='Close' onclick=\"$('#listaSelMaps').trigger('heightChange');\"><span aria-hidden='true'>&times;</span></button><strong>"+nombresLinea[i]+"</strong><br/><em>"+jerarqLevel[i]+"</em><br/><a href='"+hojasReg[i]+"' target='_blank'><small>"+codigosINSPIRE[i]+"</small></a><br/><a class='btn btn-primary btn-xs' role='button' href='"+hojasReg[i]+"' target='_blank'>Consultar la Hoja registral</a></div>";var resultsPrevios=container.innerHTML;container.innerHTML=cadHTML+resultsPrevios}},error:function(e){},complete:function(){0==numLineas&&getWMSAU(bbox,width,height,longitude,latitude),$("#resultNoSpin").show(),$("#resultSpin").hide()}}),$(".listaSelMapsclass").show(500)}function onPointerClick(event){var extent=objMap.getView().calculateExtent(objMap.getSize());extent=ol.proj.transformExtent(extent,"EPSG:3857","EPSG:4326");var centro=objMap.getView().getCenter();centro=ol.proj.toLonLat(centro,"EPSG:3857");var pixel=objMap.getEventPixel(event.originalEvent),pointClick=objMap.getCoordinateFromPixel(pixel);(pointClick=ol.proj.toLonLat(pointClick,"EPSG:3857"),$("#acumularResults").is(":checked"))&&(document.getElementById("listaSelMaps").innerHTML="");objMap.getLayers().forEach(function(layer,iLayer,layers){1==layer.getProperties().visible&&"BDLJE"==layer.getProperties().keyname?getWMSAB(extent,objMap.getSize()[0],objMap.getSize()[1],parseInt(pixel[0]),parseInt(pixel[1])):1==layer.getProperties().visible&&1==layer.getProperties().queryable&&"WMTS"==layer.getProperties().tiposerv?(urlQueryGFI=layer.getProperties().urlQuery,layerQueryGFI=layer.getProperties().layerQuery,getURLGetFeatureInfo4WMTSLayer(urlQueryGFI,layerQueryGFI,event,objMap.getView().getResolution(),layer.getProperties().useproxy)):1==layer.getProperties().visible&&1==layer.getProperties().queryable&&0==layer.getProperties().useproxy&&"BDLJE"!=layer.getProperties().keyname?getURLGetFeatureInfoLayer(layer,event,objMap.getView().getResolution()):1==layer.getProperties().visible&&1==layer.getProperties().queryable&&1==layer.getProperties().useproxy&&"BDLJE"!=layer.getProperties().keyname&&getURLGetFeatureInfoLayerWithProxy(layer,event,objMap.getView().getResolution())}),objMap.getLayers().forEach(function(grupoLayers,i){grupoLayers instanceof ol.layer.Group&&"Capas WMS de usuario"==grupoLayers.getProperties().title&&grupoLayers.getLayers().forEach(function(sublayer,j){1==sublayer.getProperties().visible&&getURLGetFeatureInfoLayerWithProxy(sublayer,event,objMap.getView().getResolution())})})}$("#listaSelMaps").bind("heightChange",function(){$(this).find(".infoBDLJE").length+$(this).find(".infoWMS").length<2&&$(".listaSelMapsclass").fadeOut(500)});
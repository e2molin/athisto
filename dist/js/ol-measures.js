var listener,sketch,helpTooltipElement,helpTooltip,measureTooltipElement,measureTooltip,draw,wgs84Sphere=new ol.Sphere(6378137),measurementsSource=new ol.source.Vector,continuePolygonMsg="Click para continuar dibujando el área",continueLineMsg="Click para continuar dibujando la polilínea",beginMeasurement=!1,useGeodesicMeasures=!0;$("#measureP").hover(function(){$("#btnToolDescript").html("<small><em>Desplazar el mapa</em></small>")}),$("#measureL").hover(function(){$("#btnToolDescript").html("<small><em>Medir longitud</em></small>")}),$("#measureA").hover(function(){$("#btnToolDescript").html("<small><em>Medir área</em></small>")}),$("#measureD").hover(function(){$("#btnToolDescript").html("<small><em>Borrar mediciones</em></small>")}),$("#mapToolbox .modal-content").hover(function(){$("#btnToolDescript").html("")});var interaction,vectorMeasures_Lyr=new ol.layer.Vector({zIndex:1e3,source:measurementsSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),formatLength=function(line){var length;if(1==useGeodesicMeasures){var coordinates=line.getCoordinates();length=0;for(var sourceProj=objMap.getView().getProjection(),i=0,ii=coordinates.length-1;i<ii;++i){var c1=ol.proj.transform(coordinates[i],sourceProj,"EPSG:4326"),c2=ol.proj.transform(coordinates[i+1],sourceProj,"EPSG:4326");length+=wgs84Sphere.haversineDistance(c1,c2)}}else length=Math.round(100*line.getLength())/100;return 100<length?Math.round(length/1e3*100)/100+" km":Math.round(100*length)/100+" m"},formatArea=function(polygon){var area;if(1==useGeodesicMeasures){var sourceProj=objMap.getView().getProjection(),coordinates=polygon.clone().transform(sourceProj,"EPSG:4326").getLinearRing(0).getCoordinates();area=Math.abs(wgs84Sphere.geodesicArea(coordinates))}else area=polygon.getArea();return 1e4<area?Math.round(area/1e6*100)/100+" km<sup>2</sup>":Math.round(100*area)/100+" m<sup>2</sup>"},pointerMoveHandler=function(evt){if(!evt.dragging){var helpMsg="Click para definir la zona a medir";if(sketch){var geom=sketch.getGeometry();geom instanceof ol.geom.Polygon?helpMsg=continuePolygonMsg:geom instanceof ol.geom.LineString&&(helpMsg=continueLineMsg)}helpTooltipElement.innerHTML=helpMsg,helpTooltip.setPosition(evt.coordinate),1==beginMeasurement&&$(helpTooltipElement).removeClass("hidden")}};function activateMeasurementTools(mapOL3){mapOL3.addLayer(vectorMeasures_Lyr),mapOL3.on("pointermove",pointerMoveHandler),$(mapOL3.getViewport()).on("mouseout",function(){$(helpTooltipElement).addClass("hidden")}),createHelpTooltip()}function addEventsOnDraw(){draw.on("drawstart",function(evt){sketch=evt.feature;var tooltipCoord=evt.coordinate;listener=sketch.getGeometry().on("change",function(evt){var output,geom=evt.target;geom instanceof ol.geom.Polygon?(output=formatArea(geom),tooltipCoord=geom.getInteriorPoint().getCoordinates()):geom instanceof ol.geom.LineString&&(output=formatLength(geom),tooltipCoord=geom.getLastCoordinate()),measureTooltipElement.innerHTML=output,measureTooltip.setPosition(tooltipCoord)})},this),draw.on("drawend",function(evt){measureTooltipElement.className="tooltip tooltip-static",measureTooltip.setOffset([0,-7]),measureTooltipElement=sketch=null,createMeasureTooltip(),ol.Observable.unByKey(listener)},this)}function addInteractionMeasureLength(){draw=new ol.interaction.Draw({source:measurementsSource,type:"LineString",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.5)",lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})})}),addEventsOnDraw()}function addInteractionMeasureArea(){draw=new ol.interaction.Draw({source:measurementsSource,type:"Polygon",style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.5)",lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})})}),addEventsOnDraw()}function createHelpTooltip(){helpTooltipElement&&helpTooltipElement.parentNode.removeChild(helpTooltipElement),(helpTooltipElement=document.createElement("div")).className="tooltip hidden",helpTooltip=new ol.Overlay({element:helpTooltipElement,offset:[15,0],positioning:"center-left"}),objMap.addOverlay(helpTooltip)}function createMeasureTooltip(){measureTooltipElement&&measureTooltipElement.parentNode.removeChild(measureTooltipElement),(measureTooltipElement=document.createElement("div")).className="tooltip tooltip-measure",measureTooltip=new ol.Overlay({element:measureTooltipElement,offset:[0,-15],positioning:"bottom-center"}),objMap.addOverlay(measureTooltip)}$("#toolboxMeasures .btn").on("click",function(event){switch(objMap.removeInteraction(draw),beginMeasurement=!1,$(this).attr("id")){case"measureL":$(".tooltip").show(),beginMeasurement=!0,addInteractionMeasureLength(),createMeasureTooltip(),objMap.addInteraction(draw);break;case"measureA":$(".tooltip").show(),beginMeasurement=!0,addInteractionMeasureArea(),createMeasureTooltip(),objMap.addInteraction(draw);break;case"measureD":measurementsSource.clear(),$(".tooltip-static").remove()}});